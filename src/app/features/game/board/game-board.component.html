<div class="game-board-container">
  <!-- HEADER -->
  <div class="game-header">
    <div class="header-left">
      <div class="player-info d-flex align-items-center gap-2">
        <i class="fas fa-user-circle fs-2 text-primary"></i>
        <span class="player-name">{{ playerName() }}</span>
      </div>
    </div>

    <div class="header-center">
      <div class="difficulty-section">
        <span class="difficulty-label">Dificultad</span>
        <div class="difficulty-bar">
          <div class="difficulty-progress" [style.width.%]="difficultyPercentage()"></div>
        </div>
        <span class="difficulty-value">{{ difficulty().toFixed(1) }}/5</span>
      </div>
    </div>

    <div class="header-right">
      <div class="stats-group d-flex align-items-center gap-4">
        <div class="stat-item d-flex align-items-center gap-2">
          <i class="fas fa-heart fs-1 text-danger me-2"></i>
          <span class="lives-value">{{ lives() }}/3</span>
        </div>
        <div class="stat-item d-flex align-items-center gap-2">
          <i class="fas fa-trophy fs-1 text-warning me-2"></i>
          <span class="score-value">{{ score() }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="game-content">
    <!-- LOADING STATE -->
    @if (gameState() === 'loading') {
      <div class="loading-screen">
        <div class="spinner"></div>
        <p>Cargando pregunta...</p>
      </div>
    }

    <!-- PLAYING STATE -->
    @if (gameState() === 'playing' && currentQuestion()) {
      <div class="playing-screen">
        <!-- Question Card -->
        <div class="question-section">
          <div class="question-card">
            <div class="question-header">
              <span class="question-number">Pregunta #{{ questionCount() }}</span>
              <div [class]="'timer ' + getTimerColor()" class="d-flex align-items-center gap-2">
                <i class="fas fa-clock fs-1 text-primary me-2"></i>
                <span class="timer-value">{{ questionTimer() }}s</span>
              </div>
            </div>
            <div class="question-statement">
              {{ currentQuestion()!.statement }}
            </div>
          </div>
        </div>

        <!-- Options Grid -->
        <div class="options-section">
          <div class="options-grid">
            @for (option of currentQuestion()!.options; track option.id) {
              <button
                class="btn btn-lg border border-2 w-100 py-4 d-flex justify-content-between align-items-center"
                [ngClass]="getOptionClass(option.id) ? (getOptionClass(option.id) === 'option-selected' ? 'btn-light-primary border-primary' : (getOptionClass(option.id) === 'option-correct' ? 'btn-light-success border-success' : 'btn-light-danger border-danger')) : 'btn-outline-secondary'"
                (click)="selectOption(option.id)"
                [disabled]="isAnswering()"
              >
                <span class="option-text">{{ option.text }}</span>
                <span class="option-indicator"></span>
              </button>
            }
          </div>
        </div>

        <!-- Submit Button -->
        <div class="action-section">
          <button
            class="btn btn-submit"
            (click)="submitAnswer()"
            [disabled]="selectedOptionId() === null || isAnswering()"
          >
            <span *ngIf="!isAnswering()">Enviar Respuesta</span>
            <span *ngIf="isAnswering()">
              <span class="spinner-small"></span> Verificando...
            </span>
          </button>
        </div>
      </div>
    }

    <!-- FEEDBACK STATE -->
    @if (gameState() === 'feedback' && feedbackData()) {
      <div class="feedback-screen">
        <!-- Feedback Card -->
        <div class="feedback-card" [ngClass]="isAnswerCorrect() ? 'success' : 'error'">
          <!-- Result Icon and Status -->
          <div class="feedback-header d-flex flex-column align-items-center gap-3">
            @if (isAnswerCorrect()) {
              <i class="fas fa-check fs-2x text-success"></i>
            } @else {
              <i class="fas fa-times fs-2x text-danger"></i>
            }
            <h2 class="result-title">
              {{ isAnswerCorrect() ? '¡Correcto!' : 'Respuesta Incorrecta' }}
            </h2>
          </div>

          <!-- Score Delta -->
          <div class="score-delta" [ngClass]="isAnswerCorrect() ? 'positive' : 'neutral'">
            @if (isAnswerCorrect()) {
              <span class="delta-icon">+{{ feedbackData()?.score }}</span>
            } @else {
              <span class="delta-icon">{{ feedbackData()?.score }}</span>
            }
          </div>

          <!-- Explanation Section (CRÍTICO - Educativo) -->
          <div class="explanation-section">
            <span class="explanation-label d-flex align-items-center gap-2">
              <i class="fas fa-book fs-1 text-primary"></i>
              Explicación Médica:
            </span>
            <p class="explanation-text">
              {{ feedbackData()?.explanation || 'No hay explicación disponible' }}
            </p>
          </div>

          <!-- Correct Option Info -->
          <div class="correct-answer-section">
            <span class="correct-label">Respuesta Correcta:</span>
            <div class="correct-option">
              @for (option of currentQuestion()!.options; track option.id) {
                @if (option.id === feedbackData()?.correct_option_id) {
                  {{ option.text }}
                }
              }
            </div>
          </div>

          <!-- Stats Update -->
          <div class="stats-update">
            <div class="stat-update-item">
              <span class="stat-update-label">Puntuación Total:</span>
              <span class="stat-update-value">{{ score() }}</span>
            </div>
            <div class="stat-update-item">
              <span class="stat-update-label">Vidas Restantes:</span>
              <span class="stat-update-value">{{ lives() }}/3</span>
            </div>
            <div class="stat-update-item">
              <span class="stat-update-label">Nueva Dificultad:</span>
              <span class="stat-update-value">{{ difficulty().toFixed(1) }}</span>
            </div>
          </div>
        </div>

        <!-- Next Button -->
        <div class="action-section">
          <button class="btn btn-next" (click)="nextQuestion()">
            Siguiente Pregunta →
          </button>
        </div>
      </div>
    }

    <!-- GAME OVER STATE -->
    @if (gameState() === 'gameover') {
      <div class="gameover-screen">
        <div class="gameover-card d-flex flex-column align-items-center text-center">
          <i class="fas fa-gamepad fs-2x text-warning mb-3"></i>
          <h2 class="gameover-title">¡Fin del Juego!</h2>
          <p class="gameover-message">
            Completaste {{ questionCount() }} preguntas con una puntuación de {{ score() }} puntos.
          </p>
          <p class="gameover-redirect">
            Redirigiendo a tu perfil...
          </p>
        </div>
      </div>
    }
  </div>
</div>

